{"ast":null,"code":"import { createApi, fetchBaseQuery } from \"@reduxjs/toolkit/query/react\";\nimport { setCredentials, logOut } from \"../../features/auth/authSlice\";\nconst baseQuery = fetchBaseQuery({\n  baseUrl: \"http://localhost:3333\",\n  credentials: \"include\",\n  prepareHeaders: (headers, _ref) => {\n    let {\n      getState\n    } = _ref;\n    const token = getState().auth.token;\n\n    if (token) {\n      headers.set(\"authorization\", `Bearer ${token}`);\n    }\n\n    return headers;\n  }\n});\n\nconst baseQueryWithReauth = async (args, api, extraOptions) => {\n  var _result, _result$error;\n\n  let result = await baseQuery(args, api, extraOptions);\n  console.log(\"baseQuery\", baseQuery);\n\n  if (((_result = result) === null || _result === void 0 ? void 0 : (_result$error = _result.error) === null || _result$error === void 0 ? void 0 : _result$error.originalStatus) === 403) {\n    console.log(\"sending refresh token\"); // send refresh token to get new access token\n\n    const refreshResult = await baseQuery(\"/refresh\", api, extraOptions);\n    console.log(refreshResult);\n\n    if (refreshResult !== null && refreshResult !== void 0 && refreshResult.data) {\n      const user = api.getState.auth.user; //store the new token\n\n      api.dispatch(setCredentials({ ...refreshResult.data,\n        user\n      })); // retry the original query with new access token\n\n      result = await baseQuery(args, api, extraOptions);\n    } else {\n      api.dispatch(logOut());\n    }\n  }\n\n  return result;\n};\n\nexport const apiSlice = createApi({\n  baseQuery: baseQueryWithReauth,\n  endpoints: builder => ({})\n});","map":{"version":3,"names":["createApi","fetchBaseQuery","setCredentials","logOut","baseQuery","baseUrl","credentials","prepareHeaders","headers","getState","token","auth","set","baseQueryWithReauth","args","api","extraOptions","result","console","log","error","originalStatus","refreshResult","data","user","dispatch","apiSlice","endpoints","builder"],"sources":["/Users/tomas/Documents/Github/ababa-task/client/src/app/api/apiSlice.js"],"sourcesContent":["import { createApi, fetchBaseQuery } from \"@reduxjs/toolkit/query/react\";\nimport { setCredentials, logOut } from \"../../features/auth/authSlice\";\n\nconst baseQuery = fetchBaseQuery({\n  baseUrl: \"http://localhost:3333\",\n  credentials: \"include\",\n  prepareHeaders: (headers, { getState }) => {\n    const token = getState().auth.token;\n    if (token) {\n      headers.set(\"authorization\", `Bearer ${token}`);\n    }\n    return headers;\n  },\n});\n\nconst baseQueryWithReauth = async (args, api, extraOptions) => {\n  let result = await baseQuery(args, api, extraOptions);\n\n  console.log(\"baseQuery\", baseQuery);\n\n  if (result?.error?.originalStatus === 403) {\n    console.log(\"sending refresh token\");\n    // send refresh token to get new access token\n\n    const refreshResult = await baseQuery(\"/refresh\", api, extraOptions);\n    console.log(refreshResult);\n\n    if (refreshResult?.data) {\n      const user = api.getState.auth.user;\n      //store the new token\n      api.dispatch(setCredentials({ ...refreshResult.data, user }));\n      // retry the original query with new access token\n      result = await baseQuery(args, api, extraOptions);\n    } else {\n      api.dispatch(logOut());\n    }\n  }\n\n  return result;\n};\n\nexport const apiSlice = createApi({\n  baseQuery: baseQueryWithReauth,\n  endpoints: (builder) => ({}),\n});\n"],"mappings":"AAAA,SAASA,SAAT,EAAoBC,cAApB,QAA0C,8BAA1C;AACA,SAASC,cAAT,EAAyBC,MAAzB,QAAuC,+BAAvC;AAEA,MAAMC,SAAS,GAAGH,cAAc,CAAC;EAC/BI,OAAO,EAAE,uBADsB;EAE/BC,WAAW,EAAE,SAFkB;EAG/BC,cAAc,EAAE,CAACC,OAAD,WAA2B;IAAA,IAAjB;MAAEC;IAAF,CAAiB;IACzC,MAAMC,KAAK,GAAGD,QAAQ,GAAGE,IAAX,CAAgBD,KAA9B;;IACA,IAAIA,KAAJ,EAAW;MACTF,OAAO,CAACI,GAAR,CAAY,eAAZ,EAA8B,UAASF,KAAM,EAA7C;IACD;;IACD,OAAOF,OAAP;EACD;AAT8B,CAAD,CAAhC;;AAYA,MAAMK,mBAAmB,GAAG,OAAOC,IAAP,EAAaC,GAAb,EAAkBC,YAAlB,KAAmC;EAAA;;EAC7D,IAAIC,MAAM,GAAG,MAAMb,SAAS,CAACU,IAAD,EAAOC,GAAP,EAAYC,YAAZ,CAA5B;EAEAE,OAAO,CAACC,GAAR,CAAY,WAAZ,EAAyBf,SAAzB;;EAEA,IAAI,YAAAa,MAAM,UAAN,2DAAQG,KAAR,gEAAeC,cAAf,MAAkC,GAAtC,EAA2C;IACzCH,OAAO,CAACC,GAAR,CAAY,uBAAZ,EADyC,CAEzC;;IAEA,MAAMG,aAAa,GAAG,MAAMlB,SAAS,CAAC,UAAD,EAAaW,GAAb,EAAkBC,YAAlB,CAArC;IACAE,OAAO,CAACC,GAAR,CAAYG,aAAZ;;IAEA,IAAIA,aAAJ,aAAIA,aAAJ,eAAIA,aAAa,CAAEC,IAAnB,EAAyB;MACvB,MAAMC,IAAI,GAAGT,GAAG,CAACN,QAAJ,CAAaE,IAAb,CAAkBa,IAA/B,CADuB,CAEvB;;MACAT,GAAG,CAACU,QAAJ,CAAavB,cAAc,CAAC,EAAE,GAAGoB,aAAa,CAACC,IAAnB;QAAyBC;MAAzB,CAAD,CAA3B,EAHuB,CAIvB;;MACAP,MAAM,GAAG,MAAMb,SAAS,CAACU,IAAD,EAAOC,GAAP,EAAYC,YAAZ,CAAxB;IACD,CAND,MAMO;MACLD,GAAG,CAACU,QAAJ,CAAatB,MAAM,EAAnB;IACD;EACF;;EAED,OAAOc,MAAP;AACD,CAxBD;;AA0BA,OAAO,MAAMS,QAAQ,GAAG1B,SAAS,CAAC;EAChCI,SAAS,EAAES,mBADqB;EAEhCc,SAAS,EAAGC,OAAD,KAAc,EAAd;AAFqB,CAAD,CAA1B"},"metadata":{},"sourceType":"module"}